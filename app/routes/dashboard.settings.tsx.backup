import { type LoaderFunctionArgs, type ActionFunctionArgs, data } from "react-router";
import { useLoaderData, Form, useRevalidator } from "react-router";
import { requireAuth } from "~/lib/auth.server";
import { drizzle } from "drizzle-orm/d1";
import { eq, and } from "drizzle-orm";
import * as schema from "~/db/schema";
import PageHeader from "~/components/dashboard/PageHeader";
import Tabs from "~/components/dashboard/Tabs";
import Button from "~/components/dashboard/Button";
import FormSection from "~/components/dashboard/FormSection";
import { Input } from "~/components/dashboard/Input";
import { Select } from "~/components/dashboard/Select";
import WeeklySchedule from "~/components/dashboard/WeeklySchedule";
import HolidaysManager from "~/components/dashboard/HolidaysManager";
import DataTable, { type Column } from "~/components/dashboard/DataTable";
import Modal from "~/components/dashboard/Modal";
import { useState } from "react";
import {
    BuildingOfficeIcon,
    BanknotesIcon,
    Cog6ToothIcon,
    ClockIcon,
    SunIcon,
    CurrencyDollarIcon,
    PlusIcon,
} from "@heroicons/react/24/outline";
import { useToast } from "~/lib/toast";

const MONTHS = [
    { value: "1", label: "Jan" },
    { value: "2", label: "Feb" },
    { value: "3", label: "Mar" },
    { value: "4", label: "Apr" },
    { value: "5", label: "May" },
    { value: "6", label: "Jun" },
    { value: "7", label: "Jul" },
    { value: "8", label: "Aug" },
    { value: "9", label: "Sep" },
    { value: "10", label: "Oct" },
    { value: "11", label: "Nov" },
    { value: "12", label: "Dec" },
];

const DAYS = Array.from({ length: 31 }, (_, i) => ({
    value: String(i + 1),
    label: String(i + 1),
}));

export async function loader({ request, context }: LoaderFunctionArgs) {
    const user = await requireAuth(request);
    const db = drizzle(context.cloudflare.env.DB, { schema });

    if (!user.companyId) {
        throw new Response("Company not found", { status: 404 });
    }

    const [company, locations, districts, seasons, durations] = await Promise.all([
        db.select().from(schema.companies).where(eq(schema.companies.id, user.companyId)).limit(1),
        db.select().from(schema.locations).limit(100),
        db.select().from(schema.districts).limit(200),
        db.select().from(schema.seasons).where(eq(schema.seasons.companyId, user.companyId)).limit(100),
        db.select().from(schema.rentalDurations).where(eq(schema.rentalDurations.companyId, user.companyId)).limit(100),
    ]);

    if (!company || company.length === 0) {
        throw new Response("Company not found", { status: 404 });
    }

    return { user, company: company[0], locations, districts, seasons, durations };
}

export async function action({ request, context }: ActionFunctionArgs) {
    const user = await requireAuth(request);
    const db = drizzle(context.cloudflare.env.DB, { schema });
    const formData = await request.formData();
    const intent = formData.get("intent");

    if (!user.companyId) {
        return data({ success: false, message: "Company not found" }, { status: 404 });
    }

    if (intent === "updateGeneral") {
        const name = formData.get("name") as string;
        const email = formData.get("email") as string;
        const phone = formData.get("phone") as string;
        const telegram = formData.get("telegram") as string;
        const locationId = Number(formData.get("locationId"));
        const districtId = Number(formData.get("districtId"));
        const street = formData.get("street") as string;
        const houseNumber = formData.get("houseNumber") as string;
        const bankName = formData.get("bankName") as string;
        const accountNumber = formData.get("accountNumber") as string;
        const accountName = formData.get("accountName") as string;
        const swiftCode = formData.get("swiftCode") as string;
        const preparationTime = Number(formData.get("preparationTime")) || 30;
        const deliveryFeeAfterHours = Number(formData.get("deliveryFeeAfterHours")) || 0;
        const islandTripPrice = Number(formData.get("islandTripPrice")) || 0;
        const krabiTripPrice = Number(formData.get("krabiTripPrice")) || 0;
        const babySeatPricePerDay = Number(formData.get("babySeatPricePerDay")) || 0;
        const weeklySchedule = formData.get("weeklySchedule") as string;
        const holidays = formData.get("holidays") as string;

        await db.update(schema.companies)
            .set({
                name,
                email,
                phone,
                telegram,
                locationId,
                districtId,
                street,
                houseNumber,
                bankName,
                accountNumber,
                accountName,
                swiftCode,
                preparationTime,
                deliveryFeeAfterHours,
                islandTripPrice,
                krabiTripPrice,
                babySeatPricePerDay,
                weeklySchedule,
                holidays,
                updatedAt: new Date(),
            })
            .where(eq(schema.companies.id, user.companyId));

        return data({ success: true, message: "Settings updated successfully" });
    }

    // Seasons actions
    if (intent === "createSeason") {
        const seasonName = formData.get("seasonName") as string;
        const startMonth = Number(formData.get("startMonth"));
        const startDay = Number(formData.get("startDay"));
        const endMonth = Number(formData.get("endMonth"));
        const endDay = Number(formData.get("endDay"));
        const priceMultiplier = Number(formData.get("priceMultiplier"));
        const discountLabel = formData.get("discountLabel") as string | null;

        await db.insert(schema.seasons).values({
            companyId: user.companyId,
            seasonName,
            startMonth,
            startDay,
            endMonth,
            endDay,
            priceMultiplier,
            discountLabel: discountLabel || null,
        });

        return data({ success: true, message: "Season created successfully" });
    }

    if (intent === "updateSeason") {
        const id = Number(formData.get("id"));
        const seasonName = formData.get("seasonName") as string;
        const startMonth = Number(formData.get("startMonth"));
        const startDay = Number(formData.get("startDay"));
        const endMonth = Number(formData.get("endMonth"));
        const endDay = Number(formData.get("endDay"));
        const priceMultiplier = Number(formData.get("priceMultiplier"));
        const discountLabel = formData.get("discountLabel") as string | null;

        await db.update(schema.seasons)
            .set({
                seasonName,
                startMonth,
                startDay,
                endMonth,
                endDay,
                priceMultiplier,
                discountLabel: discountLabel || null,
            })
            .where(and(eq(schema.seasons.id, id), eq(schema.seasons.companyId, user.companyId)));

        return data({ success: true, message: "Season updated successfully" });
    }

    if (intent === "deleteSeason") {
        const id = Number(formData.get("id"));
        await db.delete(schema.seasons)
            .where(and(eq(schema.seasons.id, id), eq(schema.seasons.companyId, user.companyId)));

        return data({ success: true, message: "Season deleted successfully" });
    }

    // Durations actions
    if (intent === "createDuration") {
        const rangeName = formData.get("rangeName") as string;
        const minDays = Number(formData.get("minDays"));
        const maxDays = formData.get("maxDays") ? Number(formData.get("maxDays")) : null;
        const priceMultiplier = Number(formData.get("priceMultiplier"));
        const discountLabel = formData.get("discountLabel") as string | null;

        await db.insert(schema.rentalDurations).values({
            companyId: user.companyId,
            rangeName,
            minDays,
            maxDays,
            priceMultiplier,
            discountLabel: discountLabel || null,
        });

        return data({ success: true, message: "Duration created successfully" });
    }

    if (intent === "updateDuration") {
        const id = Number(formData.get("id"));
        const rangeName = formData.get("rangeName") as string;
        const minDays = Number(formData.get("minDays"));
        const maxDays = formData.get("maxDays") ? Number(formData.get("maxDays")) : null;
        const priceMultiplier = Number(formData.get("priceMultiplier"));
        const discountLabel = formData.get("discountLabel") as string | null;

        await db.update(schema.rentalDurations)
            .set({
                rangeName,
                minDays,
                maxDays,
                priceMultiplier,
                discountLabel: discountLabel || null,
            })
            .where(and(eq(schema.rentalDurations.id, id), eq(schema.rentalDurations.companyId, user.companyId)));

        return data({ success: true, message: "Duration updated successfully" });
    }

    if (intent === "deleteDuration") {
        const id = Number(formData.get("id"));
        await db.delete(schema.rentalDurations)
            .where(and(eq(schema.rentalDurations.id, id), eq(schema.rentalDurations.companyId, user.companyId)));

        return data({ success: true, message: "Duration deleted successfully" });
    }

    return data({ success: false, message: "Invalid action" }, { status: 400 });
}

export default function SettingsPage() {
    const { company, locations, districts } = useLoaderData<typeof loader>();
    const [activeTab, setActiveTab] = useState<string | number>("general");
    const [selectedLocationId, setSelectedLocationId] = useState(company.locationId);
    const [weeklySchedule, setWeeklySchedule] = useState(company.weeklySchedule || "");
    const [holidays, setHolidays] = useState(company.holidays || "");
    const toast = useToast();

    const tabs = [
        { id: "general", label: "General" },
        { id: "seasons", label: "Seasons" },
        { id: "durations", label: "Durations" },
        { id: "payments", label: "Payments" },
        { id: "currencies", label: "Currencies" },
    ];

    const filteredDistricts = districts.filter(d => d.locationId === selectedLocationId);

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        const form = e.currentTarget;
        const formData = new FormData(form);
        
        try {
            const response = await fetch(form.action, {
                method: form.method,
                body: formData,
            });
            
            if (response.ok) {
                toast.success("Settings updated successfully");
            } else {
                toast.error("Failed to update settings");
            }
        } catch (error) {
            toast.error("An error occurred");
        }
    };

    return (
        <div className="space-y-4">
            <PageHeader
                title="Settings"
                rightActions={
                    activeTab === "general" && (
                        <Button type="submit" variant="primary" form="settings-form">
                            Save
                        </Button>
                    )
                }
            />

            <Tabs tabs={tabs} activeTab={activeTab} onTabChange={setActiveTab} />

            {activeTab === "general" && (
                <Form id="settings-form" method="post" onSubmit={handleSubmit} className="space-y-4">
                    <input type="hidden" name="intent" value="updateGeneral" />

                    {/* Company Information */}
                    <FormSection title="Company Information" icon={<BuildingOfficeIcon />}>
                        <div className="space-y-4">
                            <div className="grid grid-cols-4 gap-4">
                                <Input
                                    label="Company Name"
                                    name="name"
                                    defaultValue={company.name}
                                    placeholder="e.g., Andaman Rentals"
                                    required
                                />
                                <Input
                                    label="Email Address"
                                    name="email"
                                    type="email"
                                    defaultValue={company.email}
                                    placeholder="company@example.com"
                                    required
                                />
                                <Input
                                    label="Phone Number"
                                    name="phone"
                                    defaultValue={company.phone}
                                    placeholder="+66..."
                                    required
                                />
                                <Input
                                    label="Telegram"
                                    name="telegram"
                                    defaultValue={company.telegram || ""}
                                    placeholder="@company_bot"
                                />
                            </div>

                            <div className="grid grid-cols-4 gap-4">
                                <Select
                                    label="Location"
                                    name="locationId"
                                    value={selectedLocationId.toString()}
                                    onChange={(e) => setSelectedLocationId(Number(e.target.value))}
                                    options={locations}
                                    required
                                />
                                <Select
                                    label="District"
                                    name="districtId"
                                    defaultValue={company.districtId.toString()}
                                    options={filteredDistricts}
                                    required
                                />
                                <Input
                                    label="Street"
                                    name="street"
                                    defaultValue={company.street}
                                    placeholder="e.g., Beach Road"
                                    required
                                />
                                <Input
                                    label="House Number"
                                    name="houseNumber"
                                    defaultValue={company.houseNumber}
                                    placeholder="e.g., 45/1"
                                    required
                                />
                            </div>
                        </div>
                    </FormSection>

                    {/* Bank Details */}
                    <FormSection title="Bank Details" icon={<BanknotesIcon />}>
                        <div className="grid grid-cols-4 gap-4">
                            <Input
                                label="Bank Name"
                                name="bankName"
                                defaultValue={company.bankName || ""}
                                placeholder="e.g., Bangkok Bank"
                            />
                            <Input
                                label="Account Number"
                                name="accountNumber"
                                defaultValue={company.accountNumber || ""}
                                placeholder="e.g., 123-456-7890"
                            />
                            <Input
                                label="Account Name"
                                name="accountName"
                                defaultValue={company.accountName || ""}
                                placeholder="e.g., Company Ltd."
                            />
                            <Input
                                label="SWIFT / BIC Code"
                                name="swiftCode"
                                defaultValue={company.swiftCode || ""}
                                placeholder="e.g., BKKBTHBK"
                            />
                        </div>
                    </FormSection>

                    {/* Extras */}
                    <FormSection title="Extras" icon={<Cog6ToothIcon />}>
                        <div className="grid grid-cols-4 gap-4">
                            <Input
                                label="Preparation Time (min)"
                                name="preparationTime"
                                type="number"
                                defaultValue={company.preparationTime?.toString() || "30"}
                                placeholder="30"
                            />
                            <Input
                                label="Delivery Fee (After Hours)"
                                name="deliveryFeeAfterHours"
                                type="number"
                                step="0.01"
                                defaultValue={company.deliveryFeeAfterHours?.toString() || "0"}
                                placeholder="0"
                                addonLeft="฿"
                            />
                            <Input
                                label="Island Trip Cost"
                                name="islandTripPrice"
                                type="number"
                                step="0.01"
                                defaultValue={company.islandTripPrice?.toString() || "0"}
                                placeholder="0"
                                addonLeft="฿"
                            />
                            <Input
                                label="Krabi Trip Cost"
                                name="krabiTripPrice"
                                type="number"
                                step="0.01"
                                defaultValue={company.krabiTripPrice?.toString() || "0"}
                                placeholder="0"
                                addonLeft="฿"
                            />
                        </div>
                        <div className="grid grid-cols-4 gap-4 mt-4">
                            <Input
                                label="Baby Seat Cost (per day)"
                                name="babySeatPricePerDay"
                                type="number"
                                step="0.01"
                                defaultValue={company.babySeatPricePerDay?.toString() || "0"}
                                placeholder="0"
                                addonLeft="฿"
                            />
                        </div>
                    </FormSection>

                    {/* Weekly Schedule */}
                    <input type="hidden" name="weeklySchedule" value={weeklySchedule} />
                    <WeeklySchedule value={weeklySchedule} onChange={setWeeklySchedule} />

                    {/* Holidays */}
                    <input type="hidden" name="holidays" value={holidays} />
                    <HolidaysManager value={holidays} onChange={setHolidays} />
                </Form>
            )}

            {activeTab === "seasons" && (
                <div className="bg-white rounded-3xl p-8 text-center">
                    <SunIcon className="w-16 h-16 mx-auto text-gray-400" />
                    <h3 className="mt-4 text-lg font-medium text-gray-900">Seasons Management</h3>
                    <p className="mt-2 text-sm text-gray-500">
                        Configure seasonal pricing here. Coming soon.
                    </p>
                </div>
            )}

            {activeTab === "durations" && (
                <div className="bg-white rounded-3xl p-8 text-center">
                    <ClockIcon className="w-16 h-16 mx-auto text-gray-400" />
                    <h3 className="mt-4 text-lg font-medium text-gray-900">Rental Durations</h3>
                    <p className="mt-2 text-sm text-gray-500">
                        Configure rental duration pricing here. Coming soon.
                    </p>
                </div>
            )}

            {activeTab === "payments" && (
                <div className="bg-white rounded-3xl p-8 text-center">
                    <BanknotesIcon className="w-16 h-16 mx-auto text-gray-400" />
                    <h3 className="mt-4 text-lg font-medium text-gray-900">Payment Settings</h3>
                    <p className="mt-2 text-sm text-gray-500">
                        Configure payment methods here. Coming soon.
                    </p>
                </div>
            )}

            {activeTab === "currencies" && (
                <div className="bg-white rounded-3xl p-8 text-center">
                    <CurrencyDollarIcon className="w-16 h-16 mx-auto text-gray-400" />
                    <h3 className="mt-4 text-lg font-medium text-gray-900">Currency Settings</h3>
                    <p className="mt-2 text-sm text-gray-500">
                        Configure supported currencies here. Coming soon.
                    </p>
                </div>
            )}
        </div>
    );
}
